import uuid
import ssl
import httpx
import truststore
import openai

from token_jwt import get_token


jwt = get_token()

headers = {
    "X-HSBC-E2E-Trust-Token": jwt,
    "Content-Type": "application/json",
    "x-correlation-id": str(uuid.uuid4()),
    "x-usersession-id": str(uuid.uuid4())
}

BASE_URL = "Link"
USER_ID = "UC1939194"
MODEL = "GPT-4.1"


ctx = truststore.SSLContext(ssl.PROTOCOL_TLS_CLIENT)

httpx_client = httpx.Client(
    http2=True,
    verify=ctx
)

default_headers = {
    "Content-Type": "application/json",
    "x-correlation-id": str(uuid.uuid4()),
    "x-usersession-id": str(uuid.uuid4())
}

client = openai.OpenAI(
    api_key="test",
    http_client=httpx_client,
    base_url=BASE_URL,
    default_headers=default_headers
)

extra_headers = {
    "X-HSBC-E2E-Trust-Token": jwt
}

try:
    response = client.chat.completions.create(
        model=MODEL,
        messages=[
            {"role": "user", "content": "Hello, how are you?"}
        ],
        user=USER_ID,
        extra_headers=extra_headers,
        max_tokens=150
    )

    print("Response:", response.choices[0].message.content)

except openai.APIStatusError as e:
    print(f"API Error: {e.status_code} {e.response}")
