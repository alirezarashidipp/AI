import uuid
import ssl
import httpx
import truststore
import openai
from token_jwt import get_token

def get_enterprise_client(base_url):
    ctx = truststore.SSLContext(ssl.PROTOCOL_TLS_CLIENT)
    httpx_client = httpx.Client(
        http2=True,
        verify=ctx,
        timeout=httpx.Timeout(30.0, connect=10.0)
    )
    
    return openai.OpenAI(
        api_key="internal_proxy_auth",
        base_url=base_url,
        http_client=httpx_client
    )

def execute_chat_completion(client, model, user_id, message_content):
    jwt_val = get_token()
    
    headers = {
        "X-HSBC-E2E-Trust-Token": jwt_val,
        "x-correlation-id": str(uuid.uuid4()),
        "x-usersession-id": str(uuid.uuid4()),
        "Content-Type": "application/json"
    }

    try:
        response = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "user", "content": message_content}
            ],
            user=user_id,
            extra_headers=headers,
            max_tokens=150
        )
        return response.choices[0].message.content
    except openai.APIStatusError as e:
        return f"Status Error: {e.status_code} | {e.response.text}"
    except openai.APIConnectionError:
        return "Network connectivity or Proxy issue"
    except Exception as e:
        return f"Unexpected failure: {str(e)}"

if __name__ == "__main__":
    BASE_URL = "https://api.internal.hsbc/v1"
    MODEL_NAME = "gpt-4"
    USER_ID = "UC1939194"
    
    ai_client = get_enterprise_client(BASE_URL)
    result = execute_chat_completion(
        ai_client, 
        MODEL_NAME, 
        USER_ID, 
        "Analyze this request for production readiness."
    )
    print(result)
