import requests
import uuid
import json
from pydantic import BaseModel

class JokeResponse(BaseModel):
    setup: str
    punchline: str

# استخراج Schema برای ارسال به مدل
json_format_template = {
    "type": "json_schema",
    "json_schema": {
        "name": "joke_schema",
        "schema": JokeResponse.model_json_schema(),
        "strict": True
    }
}

headers = {
    "AMToken": AMToken,
    "Content-Type": "application/json",
    "Token_Type": "SESSION_TOKEN",
    "x-correlation-id": str(uuid.uuid4()),
    "x-usersession-id": str(uuid.uuid4())
}

data = {
    "model": "GPT-4.1",
    "messages": [{"role": "user", "content": "tell a joke in json format with setup and punchline keys."}],
    "response_format": json_format_template, # اعمال فرمت Pydantic
    "max_tokens": 1000,
    "user": USER_ID,
    "temperature": 0.0
}

response = requests.post(url, headers=headers, json=data)

if response.status_code == 200:
    result = response.json()
    content = result["choices"][0]["message"]["content"]
    
    # تبدیل متن به شیء Pydantic
    joke = JokeResponse.model_validate_json(content)
    print(f"Setup: {joke.setup}")
    print(f"Punchline: {joke.punchline}")
else:
    print(f"Failed! Status: {response.status_code}, Response: {response.text}")
