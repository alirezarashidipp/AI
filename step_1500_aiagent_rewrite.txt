import uuid
import ssl
import json
import httpx
import truststore
import openai

from typing import List
from pydantic import BaseModel, Field
from token_jwt import get_token


# =========================================================
# Enterprise Connection Setup
# =========================================================

jwt = get_token()

BASE_URL = "Link"
USER_ID = "UC1939194"
MODEL = "GPT-4.1"

ctx = truststore.SSLContext(ssl.PROTOCOL_TLS_CLIENT)

httpx_client = httpx.Client(
    http2=True,
    verify=ctx,
    timeout=60
)

default_headers = {
    "Content-Type": "application/json",
    "x-correlation-id": str(uuid.uuid4()),
    "x-usersession-id": str(uuid.uuid4())
}

client = openai.OpenAI(
    api_key="test",
    http_client=httpx_client,
    base_url=BASE_URL,
    default_headers=default_headers
)

extra_headers = {
    "X-HSBC-E2E-Trust-Token": jwt
}


# =========================================================
# Structured Schema
# =========================================================

class Analysis(BaseModel):
    who: bool = Field(description="Is the actor identified")
    what: bool = Field(description="Is the task clearly defined")
    why: bool = Field(description="Is the business value explained")
    ac: bool = Field(description="Are acceptance criteria present")


class AgentOutput(BaseModel):
    rewritten_story: str
    analysis: Analysis
    missing_items: List[str]
    follow_up_questions: List[str]


# =========================================================
# LLM Call
# =========================================================

def call_llm(prompt: str) -> str:

    response = client.chat.completions.create(
        model=MODEL,
        user=USER_ID,
        extra_headers=extra_headers,
        messages=[
            {
                "role": "system",
                "content": (
                    "You are an Agile expert helping refine Jira tickets. "
                    "Check if WHO, WHAT, WHY and Acceptance Criteria exist. "
                    "Rewrite the story clearly and ask for missing parts."
                )
            },
            {"role": "user", "content": prompt}
        ],
        max_tokens=800,
        temperature=0
    )

    return response.choices[0].message.content


# =========================================================
# Prompt Builder
# =========================================================

def build_prompt(text: str) -> str:

    return f"""
Analyze the following Jira description.

Check presence of:
WHO
WHAT
WHY
ACCEPTANCE CRITERIA

Then rewrite the story.

Return JSON:

{{
 "rewritten_story": "...",
 "analysis": {{
  "who": true/false,
  "what": true/false,
  "why": true/false,
  "ac": true/false
 }},
 "missing_items": [],
 "follow_up_questions": []
}}

Jira text:
{text}
"""


# =========================================================
# Agent Logic
# =========================================================

def run_agent():

    print("\nJira AI Agent started\n")

    description = input("Paste Jira description:\n")

    prompt = build_prompt(description)

    result = call_llm(prompt)

    try:
        data = json.loads(result)
    except Exception:
        print("\nModel returned non-JSON output\n")
        print(result)
        return

    print("\n--- Rewritten Story ---\n")
    print(data["rewritten_story"])

    print("\n--- Analysis ---\n")
    print(json.dumps(data["analysis"], indent=2))

    if data["missing_items"]:
        print("\nMissing Elements:")
        for m in data["missing_items"]:
            print("-", m)

    if data["follow_up_questions"]:
        print("\nQuestions for User:")
        for q in data["follow_up_questions"]:
            print("-", q)

    # Interaction loop
    while data["missing_items"]:

        print("\nPlease answer the questions above.\n")
        user_update = input("Your update:\n")

        description = description + "\n" + user_update

        prompt = build_prompt(description)

        result = call_llm(prompt)
        data = json.loads(result)

        print("\nUpdated Story:\n")
        print(data["rewritten_story"])

        if not data["missing_items"]:
            print("\nStory is now complete.\n")
            break


# =========================================================
# Run
# =========================================================

if __name__ == "__main__":
    run_agent()
